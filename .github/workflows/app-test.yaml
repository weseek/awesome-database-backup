name: Application - Test

on:
  push:
    branches-ignore: [stable]
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  app-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    # This step loads "node_modules" from the cache which contains the cache of Turborepo.
    # The "node_modules" will be mounted with the source code when `docker compose up` is executed.
    - name: Load cache "node_modules" which includes cahce of Turborepo
      uses: actions/cache@v4
      env:
        cache-name: cache-node-modules
      with:
        path: node_modules
        key:
          ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/yarn.lock') }}
        restore-keys: |
          ${{ runner.os }}-build-${{ env.cache-name }}-
    - name: Build app container to caching
      uses: docker/build-push-action
      with:
        cahce-from: type=gha
        cahce-to: type=gha
    - name: Start all DBs and middle
      run: |
        docker compose -f .devcontainer/compose.yml -f .devcontainer/compose.override.test.yml build --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g)
        docker compose -f .devcontainer/compose.yml -f .devcontainer/compose.override.test.yml up -d
      env:
        DOCKER_BUILDKIT: 1
        COMPOSE_DOCKER_CLI_BUILD: 1
    - name: Run test
      run:
        docker compose -f .devcontainer/compose.yml -f .devcontainer/compose.override.test.yml exec -e NODE_OPTIONS -e CI -T -- node bash -c 'yarn install && yarn test'
      env:
        # Temporarily ignore warnings
        # see:
        # * https://github.com/nodejs/node/blob/59cdd4f1c246cceb89a00c37e3c819a08444c888/doc/api/deprecations.md#dep0040-nodepunycode-module
        # * https://github.com/nodejs/node/pull/56632
        NODE_OPTIONS: --no-deprecation

    - name: Show test report to result of action
      if: success() || failure()
      uses: ctrf-io/github-test-reporter@v1
      with:
        report-path: '**/ctrf/*.json'
    - name: Show coverage report follow the settings .octocov.yml
      if: success() || failure()
      uses: k1LoW/octocov-action@v1
