name: Application - Test

on:
  push:
    branches-ignore: [stable]
  pull_request:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  app-test:
    runs-on: ubuntu-latest
    steps:
    - name: Get UID/GID
      id: ids
      run: |
        echo "uid=$(id -u)" >> $USER_UID
        echo "gid=$(id -g)" >> $USER_GID
    - uses: actions/checkout@v4
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    - name: Build app container to caching
      uses: docker/build-push-action@v6
      with:
        file: .devcontainer/Dockerfile
        build-args: USER_UID,USER_GID
        cache-from: type=gha
        cache-to: type=gha
    - name: Start all DBs and middle
      run: |
        docker compose -f .devcontainer/compose.yml build --build-arg USER_UID --build-arg USER_GID
        docker compose -f .devcontainer/compose.yml up -d
    - name: Run test
      run:
        docker compose -f .devcontainer/compose.yml exec -e NODE_OPTIONS -e CI -T -- node bash -c 'yarn install && yarn test'
      env:
        # Temporarily ignore warnings
        # see:
        # * https://github.com/nodejs/node/blob/59cdd4f1c246cceb89a00c37e3c819a08444c888/doc/api/deprecations.md#dep0040-nodepunycode-module
        # * https://github.com/nodejs/node/pull/56632
        NODE_OPTIONS: --no-deprecation

    - name: Show test report to result of action
      if: success() || failure()
      uses: ctrf-io/github-test-reporter@v1
      with:
        report-path: '**/ctrf/*.json'
    - name: Show coverage report follow the settings .octocov.yml
      if: success() || failure()
      uses: k1LoW/octocov-action@v1
